(define-module (scripts jslink)
  #:use-module (system base compile)
  #:use-module (system base language)
  #:use-module (language javascript)
  #:use-module (srfi srfi-1)
  #:use-module (srfi srfi-37)
  #:use-module (ice-9 format)
  #:use-module (rnrs bytevectors)
  #:use-module (ice-9 binary-ports)
  #:export (jslink))

(define %summary "Link a JS module.")

(define* (copy-port from #:optional (to (current-output-port)) #:key (buffer-size 1024))
  (define bv (make-bytevector buffer-size))
  (let loop ()
    (let ((num-read (get-bytevector-n! from bv 0 buffer-size)))
      (unless (eof-object? num-read)
        (put-bytevector to bv 0 num-read)
        (loop)))))

(define boot-dependencies
  '(("ice-9/posix" . #f)
    ("ice-9/ports" . (ice-9 ports))
    ("ice-9/threads" . (ice-9 threads))
    ("srfi/srfi-4" . (srfi srfi-4))

    ("ice-9/deprecated" . #t)
    ("ice-9/boot-9" . #t)
    ;; FIXME: needs to be at end, or I get strange errors
    ("ice-9/psyntax-pp" . #t)
    ))

(define (fail . messages)
  (format (current-error-port) "error: 狺ア礤篌徵弩ㄥ轸暴ㄤ彐轭ワ痿轱铙扉篝镳糸镱Ж＼㈣屐稷ｆｆ灬礅溽镳钺礤狎蝈篚祠ㄡ扉篝泔铙ц屐鹂ｔ蝈篚祠┅镳糸镱ЖⅥ弪箝镱ｆｆ灬礅溽镳钺礤狎蝈篚祠箬秣鲥蝮轱瞟ㄥ轸癌┅镳糸镱Ж＼秕麴豸ｔｆ灬礅溽镳钺礤狎蝈篚祠ㄩㄡ篌镢蝈蝈篚祠э豸瘐舡骈戾ㄦ衢⑧铵镳糸镱汜铑雉忮箴邈殒殄盹蝈翳犷镱沐ㄡ扉篝泔铙э豸瘐舡骈戾狎蝈篚祠┅┅镳糸镱Ж＼溴疱钿螈ｔｆ灬礅溽镳钺礤狎蝈篚祠ㄤ彐轭蝈徜骝镯篝蜷铉螬ㄣ犰飙鏖翳轭瘐舡篝蜷铉蝈徜┅戾è溴疱钿ㄡ篌镢蝈蝈篚祠т屦孱潴┅ㄡ扉篝泔铙т屦孱潴ㄣ镱蝈徜骝镯篝蜷铉狎绌溴疱钿螬蝈篚祠┅┅镳糸镱Ж㈩锃怙雉ｆｆ灬礅溽镳钺礤狎蝈篚祠ㄡ扉篝泔铙ь锃怙雉ｔ蝈篚祠┅┅ㄤ彐轭疳蝮瀛狎珞狎珞⑿狎箦狎珲礤铘扉篝丽狎狎珞犷蝈趱蝾犷犰轶鏖翳犰翳蝈戾鲠铘镳糸镱螽ㄡ蜱蟓骘熹狎珞ワ痿轱铙灬礅溽镳钺礤狎蝈篚祠ㄦ矧磲ㄣ躜蝈铘弪蝻颦痫螋梁躅蝈泔珙辁邃镳糸镱钺礤ㄥ轸暴灬礅溽ㄦ殪蝈篚祠戾è轭瘐舡骈戾ㄡ篌镢蝈蝈篚祠ч铕豸骈戾螬┅ㄡ扉篝泔铙ч铕豸骈戾ㄣ镱骈戾轭瘐舡骈戾螬蝈篚祠┅换溴驷蹯镳糸镱鲠祯弩Жㄩ铕豸骈戾螬ㄤ屦孱潴铒怙雉ｆ┅ㄤ彐轭箬秣鲥蝮轱瞟ㄦ矧磲ｔ泔眇殪ㄇ握酋殪濠窿ア鲥蝮轱瞟ㄦ矧磲ｔ⒚镳蜷玷茅舶狈乞邋语骠麽蝈骑躅溽糸镱深惝涕沐铙糖刑龀俏糖刑鲥蝮轱矧灬翦艰趑鸷珙醍矧绡扉沐铙弩扃痨梏盱井澡轶轶骝邋箫骠麽蝈秕狎骝邋麸汨犷珏犷蝈溟篝蜷怩翦轸澡弪轶蜗琢乙廖再麸翳屮翦铘疱蝽轸翦怡灬鳟ア┅ㄤ彐轭箬秣桢祓ㄦ矧磲ｔ⒄筢珏牦扉铍巯性上屋粕膛涕铍梳鲠筱蜷痿粕膛鏖翳犰轸溴疱钿孱汩弩璎桢祓痱轭翳轶桢祓礤篌徵铿秕麴豸较粕膛黩轸秕麴豸麸掀商铿溴疱钿蠼呐徜溴疱钿孱泫镱呐义痫螋怩珞麸件辆アョ蹰戾怩绛蝈痫螋徜潋弩螬ㄤ彐轭濯扉铍骈戾骈戾：脲ㄥ趄岘溴疱钿孱汩弩Ж┅秕麴豸骈戾铒怙雉咯戾è溴疱钿孱汩弩ㄩ铒怙雉屮趄岘溴疱钿孱汩弩ㄡ痧孱怙雉溴疱钿孱汩弩屮趄岘溴疱钿孱汩弩┅秕麴豸骈戾矧秕麴豸骈戾㈨衢町牦┅换粕赝藕汨犷珏徕戾鏖翳秕麴豸麸骈戾秕麴豸骈戾灬礅溽īㄦ矧磲ｔㄦ躅泗轱ī茴扉铍蝓铘轫濠ㄦ矧磲ｔ孱镦蝓铘轫茴ㄦ矧遽汨灬礅溽戾è疳翳ㄣ狎┅ㄦ殪ㄣ潋┅扉铍溴疱钿孱泫疳翳骈戾┅ㄦ矧磲ｔ茴┅溴疱钿孱汩弩ㄦ矧磲ｔ孱镦溴疱钿孱汩弩茴扉铍磲轭骈戾铒怙雉咯ㄦ矧磲ｔ┄┗秕麴豸骈戾┅┅ㄤ彐轭蝓铘轫瀛骈戾ē箦狎汨祜徜疳翳㈧犷珲徵瀵牦殪蝓铘轫瀹牦┅ㄤ彐轭扉铍蝓铘轫濠ㄣ犰飙鏖翳轭瘐舡骈戾蝓铘轫瀛骈戾泔瘗痫螋┅ㄤ彐轭扉铍溴疱钿孱泫疳翳骈戾ㄤ彐轭ㄣ镯痖戾溴疱钿孱泫骈戾ㄣ犰飙鏖翳轭瘐舡骈戾骈戾灬礅溽ㄩ瞟è灬铉踽珏痱轭翦祜镫躔灬铉踽珏ш狯狍泸轲舂蝈徜犷洵泔眇殪轭：骝镯筱桢礤：麸ш狯狍泸轲：孱ㄤ彐狨祠孱鲩蝻铐孱祜镫躔灬铉踽珏筱桢礤┅ㄣ躜蝈铘秕麴豸痫螋┅┅ㄦ矧磲ｔ⑩镲暨盹漉戾筵筝杰睥疳翳ㄣ镱è篝蜷铉骈戾ㄣ镯痖戾溴疱钿孱泫骈戾┅è扉篝骈戾痱轭舡篝狒屙孱ㄣ镯痖戾啜溴骈铄盹漉戾骈戾：骝镯筱桢礤：麸ш狯狍泸轲舂ㄣ躜蝈铘秕麴豸痫螋┅铄黛轭濠ㄦ殪ㄣ镯痖戾溴疱钿孱泫ē箦狎汨祜徜疳翳疳翳┅ㄥ祗ㄦ矧磲ｔ㈡躅泗轱ㄣ镱舂蝈趱蝾泔铘筱桢礤瘴呐粕闻末虎┅铄黛轭濠ㄤ彐轭扉铍磲轭骈戾铒怙雉咯换粕赝藕泔铘轭踽糸镱箬秕熹忮汨犷珏徕戾鏖翳篦轸汨ㄣ犰飙鏖翳轭瘐舡骈戾骈戾灬礅溽ㄩ瞟ㄦ矧磲ｔⅥ狎磲轭杰睥ㄣ镳痫螋轭铄黛轭濠ㄩ铒怙雉ㄦ矧磲ｔ㈨衢瞑筱桢礤轭轸獒爝泔铘┗茴ㄦ矧磲ｔ⑩镲暨盹漉戾筵堍殂瀛汞怙雉管⑤ㄦ躅泗轱瞑蝈趱蝾磲轭è骢钽糸镱泔铙镬瀹祜绋┗蝈趱蝾┅积┗┅┅筱桢礤轭轸獒爝泔铘ㄤ彐轭牦扉铍狎珞戾舄è镳糸镱疳蝮瀛狎珞狎珞┅ㄨ屐鹂ㄡ篌镢蝈镳糸镱ц屐鹂┅ㄤ屦孱溴钽殄ㄡ篌镢蝈镳糸镱т屦孱潴┅ㄩ铕豸骈戾ㄡ篌镢蝈镳糸镱ч铕豸骈戾螬秕麴豸骈戾ㄡ篌镢蝈镳糸镱э豸瘐舡骈戾┅铒怙雉ㄡ篌镢蝈镳糸镱ь锃怙雉咯┅ㄩ矧桢祓铛祆轭瘐舡骈戾螬ㄢ彗轭箬秣桢祓ㄥ轸癌┅躅戾篌铛祆ㄣ潋轭瘐舡骈戾螬ㄦ衢汜镱禊扉铍镱骈戾狒糸礤┅ㄦ矧磲ｔⅦ蝻翦帼璃茴扉铍骈戾ㄣ狎轭瘐舡骈戾螬：屮趄岘溴疱钿孱汩弩溴疱钿孱汩弩：秕麴豸骈戾秕麴豸骈戾：铒怙雉铒怙雉咯┅ㄤ彐轭磲轭牦扉铍